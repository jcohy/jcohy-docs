:metadata-file-spec: https://github.com/gradle/gradle/blob/master/subprojects/docs/src/docs/design/gradle-module-metadata-latest-specification.md

[[sec:understanding-gradle-module-md]]
= 理解 Gradle 模块元数据

Gradle 模块元数据是一种用于序列化 Gradle 组件模型的格式。 它类似于 https://maven.apache.org/pom.html[Apache Maven™'s POM file]  或 http://ant.apache.org/ivy/[Apache Ivy™ ivy.xml] 文件。 元数据文件的目标是向使用者提供存储库上发布的内容的合理模型。

Gradle 模块元数据是一种独特的格式，目的是使其具有多平台的感知能力来提高依赖关系解析度。

具体而言，Gradle 模块元数据支持:

- <<rich_versions.adoc#rich-version-constraints,丰富版本约束>>
- <<dependency_constraints.adoc#sec:adding-constraints-transitive-deps,依赖约束>>
- <<component_capabilities.adoc#declaring-component-capabilities,组件功能>>
- <<variant_model.adoc#understanding-variant-selection,变体感知解析>>

Gradle 模块元数据的 Publication 将为您的使用者提供更好的依赖关系管理：

- 通过检测 <<component_capabilities.adoc#declaring-component-capabilities,不兼容模块>> 及早的发现问题
- 一致 <<cross_project_publications.adoc#targeting-different-platforms,特定平台的依赖>>
- 本地 <<dependency_version_alignment.adoc#version_alignment, 依赖版本对其>>
- 自动获取 <<feature_variants.adoc#,特定功能的库的依赖>>

Gradle 模块元数据会在使用 <<publishing_maven.adoc#,Maven Publish plugin>> 或 <<publishing_ivy.adoc#,Ivy Publish plugin>> 时自动发布.

旧版的 `maven` 和 `ivy` 插件不支持.

Gradle 模块元数据的规范可以在 {metadata-file-spec}[这里] 找到。

[[sub:mapping-with-other-formats]]
== 使用其他格式映射

Gradle 模块元数据会自动发布在 Maven 或 Ivy 存储库中。 但是，它不会取代 _pom.xml_ 或 _ivy.xml_ 文件：它与这些文件一起发布。 这样做是为了最大限度地提高与第三方构建工具的兼容性。

Gradle 尽最大努力将 Gradle 特定概念映射到 Maven 或 Ivy。 当构建文件只能在 Gradle 模块元数据中使用表示的功能时，Gradle 会在发布时向您发出警告。 下表总结了如何将某些 Gradle 特定功能映射到 Maven 和 Ivy：

.Mapping of Gradle specific concepts to Maven and Ivy
|===
|Gradle|Maven|Ivy|Description

|<<dependency_constraints.adoc#sec:adding-constraints-transitive-deps,依赖关系约束>>
|`<dependencyManagement>` 依赖
|未发布
|Gradle 的依赖约束是可以 _传递的_, 而 Maven 的依赖项管理块不是

|<<rich_versions.adoc#rich-version-constraints,丰富的版本约束>>
|发布 _所需_ 版本
|已发布 _所需_ 版本
|

|<<component_capabilities.adoc#declaring-component-capabilities,组建功能>>
|未发布
|未发布
|组件功能是 Gradle 独有的

|<<feature_variants.adoc#,功能变体>>
|上传变体构件，将依赖作为可选依赖项发布
|上传变体构件，不发布依赖项
|功能变体是可选依赖项的良好替代品

|<<publishing_customization.adoc#sec:publishing-custom-components,自定义组件类型>>
|上传构件，依赖是映射描述的依赖
|上传项目，忽略依赖
|在任何情况下，自定义组件类型都可能无法从 Maven 或 Ivy 使用。它们通常存在于自定义生态系统的上下文中

|===

=== 禁用元数据兼容性发布警告

如果要禁止显示警告，可以使用以下 API 执行此操作:

* 对于 Maven, 请查看 link:{groovyDslPath}/org.gradle.api.publish.maven.MavenPublication.html#org.gradle.api.publish.maven.MavenPublication:suppressAllPomMetadataWarnings()[MavenPublication] 中的`suppress*` 方法
* 对于 Ivy, 请查看 link:{groovyDslPath}/org.gradle.api.publish.ivy.IvyPublication.html#org.gradle.api.publish.ivy.IvyPublication:suppressAllIvyMetadataWarnings()[IvyPublication] 中的 `suppress*` 方法


.Disabling publication warnings
====
include::{snippets-dir}/dependencyManagement/modelingFeatures-outgoingCapabilities/groovy/build.gradle[tags=ignore-pom-warnings]
include::{snippets-dir}/dependencyManagement/modelingFeatures-outgoingCapabilities/kotlin/build.gradle.kts[tags=ignore-pom-warnings]
====

[[sub:interactions-other-build-tools]]
== 与其他构建工具的交互

由于 Gradle 模块元数据的传播范围并不广泛，并且旨在 <<#sub:mapping-with-other-formats,最大限度地提高与其他工具的兼容性>> ，因此 Gradle 做了几件事:

- Gradle 模块元数据与给定存储库(Maven 或 Ivy) 的正常描述符一起系统的发布
- `pom.xml` 或 `ivy.xml` 文件将包含一个 _marker comment_ ，告诉 Gradle 该模块存在 Gradle Module Metadata

标记的目的是 _不_ 让其他工具解析模块元数据：它仅适用于 Gradle 用户。 它向 Gradle 解释说存在一个 _better_ 模块元数据文件，并且应该使用它。
这并不意味着会破坏来自 Maven 或 Ivy 的使用者，只是它在 <<#sub:mapping-with-other-formats,degraded mode>> 下工作。

[NOTE]
====
这必须被视为一种 _性能优化_：Gradle 将首先查看最有可能存在的文件，然后仅在模块实际使用 Gradle 模块元数据发布时才执行 2 个请求，一个用于获取 Gradle 模块元数据，然后一个用于获取 POM/Ivy 文件以防未命中。
====

如果您知道所依赖的模块始终与 Gradle 模块元数据一起发布，则可以通过为存储库配置元数据源来优化网络调用:

.Resolving Gradle Module Metadata only
====
include::{snippets-dir}/dependencyManagement/modelingFeatures-crossProjectPublications-advanced-published/groovy/producer/build.gradle[tags=gradle_metadata_source]
include::{snippets-dir}/dependencyManagement/modelingFeatures-crossProjectPublications-advanced-published/kotlin/producer/build.gradle.kts[tags=gradle_metadata_source]
====

[[sub:gmm-validation]]
== Gradle 模块元数据验证

Gradle 模块元数据在发布之前经过验证。

强制执行以下规则：

* 变体名必须是唯一的,
* 每个变体必须至少 <<variant_attributes.adoc#,有一个属性>>,
* 两个变体不能具有 <<variant_model.adoc#,完全相同的属性和功能，>>,
* 如果存在依赖，则所有变体中至少有一个依赖必须携带 <<rich_versions.adoc#,版本信息>>.

这些规则可确保生成的元数据的质量，可以邦之您使用时不会有问题。.

[[sub:gmm-reproducible]]
== Gradle 模块元数据可重用性

生成模块元数据文件的任务目前从未由 Gradle 标记，因为它的实现方式。 但是，如果生成输入和生成脚本均未更改，则任务结果实际上是最新的：它始终生成相同的输出。UP-TO-DATE

如果用户希望每次生成调用都有一个唯一文件，则可以将生成的元数据中的标识符链接到创建它的生成。 用户可以选择在其以下项中启用此唯一标识符：modulepublication

默认情况下，Gradle 模块元数据文件包含生成它的构建的唯一 ID。 这意味着文件总是不同的。

用户可以在  `publication` 中禁用这个唯一标识符：

.Configure the build identifier of a publication
====
include::{snippets-dir}/publishing/javaLibrary/groovy/build.gradle[tags=disable-build-id]
include::{snippets-dir}/publishing/javaLibrary/kotlin/build.gradle.kts[tags=disable-build-id]
====

通过上述更改，生成的 Gradle 模块元数据文件将始终保持不变，从而允许下游任务将其视为最新的。

[NOTE]
====
The task generating the module metadata files is currently never marked `UP-TO-DATE` by Gradle due to the way it is implemented.
However, if the build identifier is skipped, and no build inputs nor build scripts changed, the task is effectively up-to-date (it always produces the same output).
====

[[sub:disabling-gmm-publication]]
== 禁用 Gradle 模块元数据发布

在某些情况下，您可能希望禁用 Gradle 模块元数据的发布：

- 您要上传的存储库拒绝元数据文件（未知格式）
- 您正在使用未正确映射到 Gradle 模块元数据的 Maven 或 Ivy 特定概念

在这种情况下，只需禁用生成元数据文件的任务即可禁用 Gradle 模块元数据的发布：

.Disabling publication of Gradle Module Metadata
====
include::{snippets-dir}/dependencyManagement/modelingFeatures-crossProjectPublications-advanced-published/groovy/producer/build.gradle[tags=disable_gradle_metadata_publication]
include::{snippets-dir}/dependencyManagement/modelingFeatures-crossProjectPublications-advanced-published/kotlin/producer/build.gradle.kts[tags=disable_gradle_metadata_publication]
====
